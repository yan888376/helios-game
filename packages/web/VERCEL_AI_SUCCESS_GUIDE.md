# ğŸš€ Vercel AI çœŸå®äº’åŠ¨å®Œæ•´å®ç°æŒ‡å—

> **æˆåŠŸæ¡ˆä¾‹**ï¼šä»Mockå“åº”åˆ°çœŸå®AIèŠå¤©çš„å®Œæ•´å®ç°æµç¨‹
> 
> **é€‚ç”¨äº**ï¼šæƒ³è¦å®ç°ç±»ä¼¼åŠŸèƒ½çš„å¼€å‘å›¢é˜Ÿå’ŒAIåŠ©æ‰‹

## ğŸ“‹ é¡¹ç›®æ¦‚è§ˆ

### ğŸ¯ æœ€ç»ˆå®ç°æ•ˆæœ
- **ç”¨æˆ·é—®é¢˜**: "ä½ ä»¬è§‰å¾—AIèƒ½çœŸæ­£ç†è§£äººç±»çš„é€‰æ‹©é€»è¾‘å—ï¼Ÿ"
- **çœŸå®AIå›åº”**: NPCsåŸºäºè§’è‰²ä¸ªæ€§ç»™å‡ºæ·±åº¦ã€ç›¸å…³ã€è‡ªç„¶çš„å›ç­”
- **å‘Šåˆ«**: æ¨¡æ¿å›ç­”ã€ç­”éæ‰€é—®ã€æœºæ¢°åŒ–å¯¹è¯

### ğŸ— æŠ€æœ¯æ¶æ„
```
å‰ç«¯ (Next.js) â†â†’ åç«¯API â†â†’ Vercel AI Gateway â†â†’ çœŸå®AIæ¨¡å‹
     â”‚                â”‚              â”‚
   ç”¨æˆ·äº¤äº’        æ¶ˆæ¯å¤„ç†        æ¨¡å‹è°ƒç”¨
   çŠ¶æ€ç®¡ç†        è§’è‰²ç³»ç»Ÿ        æµå¼å“åº”
```

---

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯å®ç°

### 1. Vercel AI Gateway é›†æˆ

#### å…³é”®ä»£ç æ¨¡å¼
```typescript
import { streamText } from 'ai'

// âœ… æ­£ç¡®ï¼šç›´æ¥ä½¿ç”¨æ¨¡å‹å­—ç¬¦ä¸²
const result = await streamText({
  model: 'openai/gpt-4o-mini',  // æ ¸å¿ƒï¼šå­—ç¬¦ä¸²æ ¼å¼
  messages: [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: userMessage }
  ],
  temperature: 0.8,
})

// âŒ é”™è¯¯ï¼šå¤æ‚çš„provideré…ç½®ï¼ˆæˆ‘ä»¬æ›¾ç»çš„é”™è¯¯ï¼‰
// const result = await streamText({
//   model: openai('gpt-4o-mini'),  // ä¸éœ€è¦è¿™æ ·
```

#### ç¯å¢ƒå˜é‡é…ç½®
```bash
# âœ… å”¯ä¸€éœ€è¦çš„ç¯å¢ƒå˜é‡
AI_GATEWAY_API_KEY=your_vercel_ai_gateway_key

# âŒ ä¸éœ€è¦è¿™äº›ï¼ˆæˆ‘ä»¬æ›¾ç»çš„å›°æƒ‘ï¼‰
# OPENAI_API_KEY=xxx
# VERCEL_AI_GATEWAY_URL=xxx
```

### 2. å‰åç«¯åä½œæœºåˆ¶

#### å‰ç«¯ (Next.js) èŒè´£
- **ç”¨æˆ·äº¤äº’**: æ”¶é›†ç”¨æˆ·è¾“å…¥ï¼Œæ˜¾ç¤ºå¯¹è¯å†å²
- **çŠ¶æ€ç®¡ç†**: ç®¡ç†èŠå¤©çŠ¶æ€ã€æ‰“å­—çŠ¶æ€ã€è‡ªä¸»å¯¹è¯çŠ¶æ€
- **APIè°ƒç”¨**: è°ƒç”¨åç«¯APIï¼Œå¤„ç†æµå¼å“åº”
- **UIæ¸²æŸ“**: è§’è‰²å¤´åƒã€æ¶ˆæ¯æ°”æ³¡ã€æ—¶é—´æˆ³

#### åç«¯ (API Routes) èŒè´£
- **è§’è‰²ç³»ç»Ÿ**: å®šä¹‰NPCä¸ªæ€§å’Œè¡Œä¸ºæ¨¡å¼
- **æ¶ˆæ¯è·¯ç”±**: ç¾¤èŠæ¨¡å¼ vs å•èŠæ¨¡å¼
- **AIè°ƒç”¨**: ä¸Vercel AI Gatewayäº¤äº’
- **Fallbackå¤„ç†**: Mockå“åº”ä½œä¸ºé™çº§æ–¹æ¡ˆ

#### å…³é”®APIç«¯ç‚¹
```typescript
// 1. ç¾¤èŠAPI - ç”¨æˆ·æ¶ˆæ¯è§¦å‘NPCå›åº”
POST /api/chat
{
  message: "ç”¨æˆ·æ¶ˆæ¯",
  mode: "group",
  conversationHistory: [...],
  topic: {...}
}

// 2. è‡ªä¸»å¯¹è¯API - NPCsä¹‹é—´çš„è‡ªå‘äº¤æµ
POST /api/npc-chat  
{
  conversationHistory: [...],
  timeOfDay: "evening",
  barActivity: "quiet"
}
```

---

## ğŸ¯ å®ç°æµç¨‹è¯¦è§£

### Phase 1: åŸºç¡€æ¶æ„æ­å»º
1. **Next.jsé¡¹ç›®ç»“æ„**
   ```
   src/
   â”œâ”€â”€ app/
   â”‚   â”œâ”€â”€ api/
   â”‚   â”‚   â”œâ”€â”€ chat/route.ts        # ç¾¤èŠAPI
   â”‚   â”‚   â””â”€â”€ npc-chat/route.ts    # è‡ªä¸»å¯¹è¯API
   â”‚   â””â”€â”€ page.tsx                 # å‰ç«¯ç•Œé¢
   â””â”€â”€ lib/
       â””â”€â”€ ai-gateway.ts            # AIé…ç½®
   ```

2. **ä¾èµ–å®‰è£…**
   ```bash
   npm install ai@^5.0.15 @ai-sdk/openai zod
   ```

### Phase 2: è§’è‰²ç³»ç»Ÿè®¾è®¡
```typescript
const characters = {
  alex: {
    name: "è‰¾å…‹æ–¯",
    occupation: "æ•°æ®åˆ†æå¸ˆ",
    systemPrompt: `ä½ æ˜¯è‰¾å…‹æ–¯ï¼Œç†æ€§ã€é€»è¾‘æ€§å¼ºçš„æ•°æ®åˆ†æå¸ˆ...`
  },
  nova: {
    name: "è¯ºå¨ƒ", 
    occupation: "åŸç”ŸAI",
    systemPrompt: `ä½ æ˜¯è¯ºå¨ƒï¼Œå¥½å¥‡ã€å“²æ€çš„AIæ„è¯†ä½“...`
  },
  rachel: {
    name: "ç‘ç§‹",
    occupation: "é…’ä¿", 
    systemPrompt: `ä½ æ˜¯ç‘ç§‹ï¼Œæ¸©æš–ã€æœ‰äººç”Ÿé˜…å†çš„é…’é¦†è€æ¿å¨˜...`
  }
}
```

### Phase 3: æ¶ˆæ¯æµå®ç°
```typescript
// å‰ç«¯å‘é€æ¶ˆæ¯
const sendMessage = async (userInput: string) => {
  // 1. æ„å»ºè¯·æ±‚
  const response = await fetch('/api/chat', {
    method: 'POST',
    body: JSON.stringify({
      message: userInput,
      mode: 'group',
      conversationHistory: recentHistory
    })
  })
  
  // 2. å¤„ç†å“åº”
  const result = await response.json()
  
  // 3. åˆ†æ‰¹æ˜¾ç¤ºå›åº”ï¼ˆæ¨¡æ‹ŸçœŸå®å¯¹è¯èŠ‚å¥ï¼‰
  result.responses.forEach((response, index) => {
    setTimeout(() => {
      addMessageToChat(response)
    }, index * 1000)
  })
}
```

### Phase 4: AI Gatewayé›†æˆ
```typescript
// æ ¸å¿ƒAIè°ƒç”¨å‡½æ•°
async function callAIGateway(systemPrompt: string, userMessage: string): Promise<string> {
  const result = await streamText({
    model: 'openai/gpt-4o-mini',
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userMessage }
    ],
    temperature: 0.8,
  })
  
  let fullResponse = ''
  for await (const chunk of result.textStream) {
    fullResponse += chunk
  }
  
  return fullResponse
}
```

---

## âš ï¸ å¸¸è§é”™è¯¯å’Œé¿å‘æŒ‡å—

### 1. AI Gatewayé…ç½®é”™è¯¯
âŒ **é”™è¯¯åšæ³•**:
```typescript
// å¤æ‚çš„provideré…ç½®
import { openai } from '@ai-sdk/openai'
const result = streamText({ model: openai('gpt-4') })
```

âœ… **æ­£ç¡®åšæ³•**:
```typescript  
// ç®€å•çš„å­—ç¬¦ä¸²æ¨¡å‹
const result = streamText({ model: 'openai/gpt-4o-mini' })
```

### 2. ç¯å¢ƒå˜é‡å‘½åæ··ä¹±
âŒ **æˆ‘ä»¬çŠ¯è¿‡çš„é”™è¯¯**:
- `OPENAI_API_KEY` 
- `VERCEL_AI_GATEWAY_API_KEY`
- `AI_GATEWAY_URL`

âœ… **æ­£ç¡®é…ç½®**:
- åªéœ€è¦ `AI_GATEWAY_API_KEY`

### 3. Mockç³»ç»Ÿå…³é”®è¯åŒ¹é…å¤±è´¥
âŒ **é—®é¢˜**: "ä½ ä»¬æ™šä¸Šåƒå•¥é¥­äº†" æ— æ³•åŒ¹é… `message.includes('åƒé¥­')`

âœ… **è§£å†³**: 
```typescript
if (message.includes('åƒ') && (message.includes('é¥­') || message.includes('é¤')) || 
    message.includes('åƒå•¥') || message.includes('åƒä»€ä¹ˆ')) {
  // å¤„ç†åƒé¥­ç›¸å…³è¯é¢˜
}
```

### 4. æ¶ˆæ¯è·¯ç”±é—®é¢˜
âŒ **ç°è±¡**: ç”¨æˆ·å‘æ¶ˆæ¯ï¼ŒNPCså¼€å§‹è‡ªè¯´è‡ªè¯
âŒ **åŸå› **: AI Gatewayæœªé…ç½® â†’ APIè¿”å›ç©ºresponses â†’ è§¦å‘è‡ªä¸»å¯¹è¯

âœ… **è§£å†³**: æ·»åŠ è¯¦ç»†è°ƒè¯•å’Œé”™è¯¯æ£€æŸ¥
```typescript
if (!result.responses || result.responses.length === 0) {
  console.error('âŒ AI Gateway may not be configured')
  // æ˜¾ç¤ºé”™è¯¯æç¤º
}
```

---

## ğŸš€ é«˜æ•ˆæ²Ÿé€šæ–¹æ³•è®º

### ä¸AIåŠ©æ‰‹åä½œçš„æœ€ä½³å®è·µ

#### 1. æä¾›å®Œæ•´ä¸Šä¸‹æ–‡
âœ… **å¥½çš„æ²Ÿé€š**:
```
"æˆ‘é—®NPCs'ä½ ä»¬è§‰å¾—AIèƒ½ç†è§£äººç±»å—ï¼Ÿ'ï¼Œä½†ä»–ä»¬å›å¤äº†ï¼š
- è¯ºå¨ƒï¼šæœ‰æ—¶å€™æˆ‘æƒ³å¦‚æœæˆ‘æœ‰å®ä½“...  
- è‰¾å…‹æ–¯ï¼šç‘ç§‹ï¼Œä½ çš„é…’é¦†æ•°æ®å¾ˆæœ‰æ„æ€...

é—®é¢˜ï¼šä»–ä»¬å®Œå…¨æ²¡å›åº”æˆ‘çš„é—®é¢˜ï¼Œåè€Œå¼€å§‹è‡ªä¸»èŠå¤©"
```

âŒ **ä½æ•ˆæ²Ÿé€š**: "NPCsä¸å›æˆ‘æ¶ˆæ¯"

#### 2. åˆ†äº«å…·ä½“æ—¥å¿—
âœ… **æä¾›è°ƒè¯•ä¿¡æ¯**:
```
åå°æ—¥å¿—æ˜¾ç¤ºï¼š
ğŸ” Group chat AI Gateway check: {
  hasKey: false,
  configured: false,
  envValue: 'MISSING'
}
```

#### 3. æè¿°æœŸæœ›ç»“æœ
âœ… **æ˜ç¡®ç›®æ ‡**: "æˆ‘å¸Œæœ›NPCsåƒçœŸäººæœ‹å‹ä¸€æ ·å›åº”æˆ‘çš„å“²å­¦é—®é¢˜ï¼Œè€Œä¸æ˜¯é¢„è®¾è¯é¢˜"

#### 4. æŠ€æœ¯æ ˆä¿¡æ¯
âœ… **å…³é”®ä¿¡æ¯**:
- Next.js 14.2.0 with App Router
- Vercel AI SDK 5.0.15
- Deployed on Vercel
- Using TypeScript

---

## ğŸ“‹ å®Œæ•´å®æ–½æ¸…å•

### å¼€å‘é˜¶æ®µ
- [ ] å®‰è£…ä¾èµ–ï¼š`ai`, `@ai-sdk/openai`, `zod`
- [ ] åˆ›å»ºè§’è‰²ç³»ç»Ÿå’Œsystem prompts
- [ ] å®ç° `/api/chat` ç¾¤èŠç«¯ç‚¹
- [ ] å®ç° `/api/npc-chat` è‡ªä¸»å¯¹è¯ç«¯ç‚¹
- [ ] æ„å»ºå‰ç«¯èŠå¤©ç•Œé¢
- [ ] æ·»åŠ è°ƒè¯•æ—¥å¿—ç³»ç»Ÿ

### éƒ¨ç½²é˜¶æ®µ
- [ ] éƒ¨ç½²åˆ°Vercel
- [ ] è·å–Vercel AI Gateway API Key
- [ ] é…ç½®ç¯å¢ƒå˜é‡ `AI_GATEWAY_API_KEY`
- [ ] æµ‹è¯•çœŸå®AIå“åº”

### éªŒè¯é˜¶æ®µ
- [ ] ç¡®è®¤çœ‹åˆ° "âœ… AI Gateway response successful"
- [ ] æµ‹è¯•ç”¨æˆ·é—®é¢˜èƒ½è·å¾—ç›¸å…³å›åº”
- [ ] éªŒè¯è§’è‰²ä¸ªæ€§å·®å¼‚åŒ–
- [ ] æ£€æŸ¥è‡ªä¸»å¯¹è¯åŠŸèƒ½

---

## ğŸ¯ æˆåŠŸæ ‡å¿—

### æŠ€æœ¯æŒ‡æ ‡
- âœ… è°ƒè¯•æ—¥å¿—æ˜¾ç¤º `AI_GATEWAY_API_KEY` å·²é…ç½®
- âœ… APIè¿”å›çœŸå®responsesè€Œéç©ºæ•°ç»„
- âœ… NPCsåŸºäºsystem promptä¸ªæ€§åŒ–å›åº”
- âœ… å…³é”®è¯åŒ¹é…å‡†ç¡®è¯†åˆ«ç”¨æˆ·æ„å›¾

### ç”¨æˆ·ä½“éªŒ
- âœ… ç”¨æˆ·é—®é¢˜è·å¾—ç›´æ¥ã€ç›¸å…³å›åº”
- âœ… NPCså±•ç°ä¸åŒä¸ªæ€§å’Œè§‚ç‚¹
- âœ… å¯¹è¯è‡ªç„¶æµç•…ï¼Œé¿å…æ¨¡æ¿åŒ–
- âœ… è‡ªä¸»å¯¹è¯ä¸°å¯Œäº’åŠ¨ä½“éªŒ

---

## ğŸ’¡ æ ¸å¿ƒæ´å¯Ÿ

### 1. ç®€å•èƒœè¿‡å¤æ‚
æœ€ç»ˆæ–¹æ¡ˆéå¸¸ç®€å•ï¼š`streamText({ model: 'openai/gpt-4o-mini' })`
æˆ‘ä»¬ä¹‹å‰å°è¯•çš„å¤æ‚provideré…ç½®éƒ½æ˜¯å¤šä½™çš„ã€‚

### 2. è°ƒè¯•ä¿¡æ¯è‡³å…³é‡è¦
è¯¦ç»†çš„æ—¥å¿—è®©æˆ‘ä»¬å¿«é€Ÿå®šä½åˆ°"æ¶ˆæ¯è·¯ç”±é—®é¢˜"è¿™ä¸ªæ ¹æœ¬åŸå› ã€‚

### 3. ç†è§£ä¸šåŠ¡æµç¨‹
æŠ€æœ¯é—®é¢˜å¾€å¾€æºäºå¯¹ä¸šåŠ¡æµç¨‹çš„è¯¯è§£ã€‚ç†æ¸…æ¥š"ç”¨æˆ·æ¶ˆæ¯ â†’ AIå›åº”"çš„å®Œæ•´é“¾è·¯æ˜¯å…³é”®ã€‚

### 4. ç¯å¢ƒå˜é‡æ˜¯å…³é”®
90%çš„é—®é¢˜éƒ½æºäºç¯å¢ƒå˜é‡é…ç½®é”™è¯¯ã€‚

---

## ğŸ¤ å›¢é˜Ÿåä½œå»ºè®®

1. **ä»£ç Review**: é‡ç‚¹æ£€æŸ¥ç¯å¢ƒå˜é‡ä½¿ç”¨å’ŒAPIè°ƒç”¨
2. **æµ‹è¯•ç­–ç•¥**: æœ¬åœ°mock + VercelçœŸå®ç¯å¢ƒåŒé‡éªŒè¯
3. **æ–‡æ¡£é©±åŠ¨**: å…ˆå†™æ¸…æ¥šæœŸæœ›è¡Œä¸ºï¼Œå†å®ç°ä»£ç 
4. **é”™è¯¯ç›‘æ§**: è¯¦ç»†æ—¥å¿—æ¯”å®Œç¾ä»£ç æ›´é‡è¦

---

**ğŸ‰ æ­å–œï¼ä½ å·²ç»æŒæ¡äº†Vercel AIçœŸå®äº’åŠ¨çš„å®Œæ•´å®ç°æ–¹æ³•ï¼**

> è®°ä½ï¼šæˆåŠŸçš„å…³é”®æ˜¯ç†è§£æ•´ä¸ªæ•°æ®æµï¼Œè€Œä¸æ˜¯è®°ä½æ¯ä¸€è¡Œä»£ç ã€‚
> 
> å½“é‡åˆ°é—®é¢˜æ—¶ï¼Œå…ˆç†æ¸…æ¥šæ•°æ®æ˜¯å¦‚ä½•æµåŠ¨çš„ï¼Œé—®é¢˜å¾€å¾€å°±èƒ½è¿åˆƒè€Œè§£ã€‚