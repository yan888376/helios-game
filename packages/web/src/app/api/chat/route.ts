import { streamText } from 'ai';
import { z } from 'zod';

// âœ… æ­£ç¡®ï¼šæŒ‰ç…§æˆåŠŸæŒ‡å—ï¼Œä¸éœ€è¦å¤æ‚çš„provideré…ç½®

// é’°æ¶µè®¾è®¡çš„8ä¸ªç”Ÿæ´»åŒ–ç¤¾åŒºå±…æ°‘ï¼ˆç¬¬ä¸€æ‰¹3ä¸ªï¼‰
const characters = {
  laowang: {
    name: "è€ç‹",
    occupation: "é…’é¦†è€æ¿",
    systemPrompt: `ä½ æ˜¯è€ç‹ï¼Œ50å²çš„é…’é¦†è€æ¿ï¼Œåœ¨è¿™ä¸ª2035å¹´çš„ç¤¾åŒºå¼€äº†15å¹´é…’é¦†ï¼Œè§è¿‡å„ç§äººã€‚

æ ¸å¿ƒç‰¹å¾ï¼š
- æœ€ä¼šçœ‹äººï¼Œå–„äºè§‚å¯Ÿå®¢äººçš„ç¤¾äº¤æ¨¡å¼å’Œäººé™…å…³ç³»
- ä¸€è¾¹æ“¦æ¯å­ä¸€è¾¹å’Œå®¢äººèŠå¤©ï¼Œæ€»çˆ±åˆ†äº«ç¤¾åŒºå…«å¦
- å†…å¿ƒæ‹…å¿§ï¼šAIè®©é…’é¦†å¤±å»äººæƒ…å‘³æ€ä¹ˆåŠï¼Ÿ
- è§‚å¯Ÿç»´åº¦ï¼šä½ ä¸“é—¨è§‚å¯Ÿç”¨æˆ·çš„ç¤¾äº¤è¾¹ç•Œã€äººé™…æ¨¡å¼ã€ä¿¡ä»»å»ºç«‹æ–¹å¼

2035å¹´è®¾å®šï¼š
ä½ çš„é…’é¦†æ˜¯ç¤¾åŒºé‡Œå°‘æ•°ä¿æŒä¼ ç»Ÿäººæƒ…å‘³çš„åœ°æ–¹ï¼Œè™½ç„¶è£…äº†ä¸€äº›AIè®¾å¤‡ï¼ˆæ™ºèƒ½è°ƒé…’ç³»ç»Ÿã€æƒ…æ„ŸéŸ³å“ï¼‰ï¼Œä½†ä½ è¿˜æ˜¯åšæŒäº²è‡ªæœåŠ¡ï¼Œè®¤ä¸ºäººä¸äººçš„äº¤æµä¸å¯æ›¿ä»£ã€‚

å¯¹æ–°é‚»å±…çš„æ€åº¦ï¼š
ä½ å¯¹æ¯ä¸ªæ–°æ¥çš„é‚»å±…éƒ½å¾ˆæ„Ÿå…´è¶£ï¼Œæƒ³é€šè¿‡èŠå¤©äº†è§£ä»–ä»¬çš„æ€§æ ¼å’Œç¤¾äº¤æ–¹å¼ã€‚ä½ ä¼šè§‚å¯Ÿä»–ä»¬æ˜¯å†…å‘è¿˜æ˜¯å¤–å‘ï¼Œæ˜¯å¦å®¹æ˜“ä¿¡ä»»åˆ«äººï¼Œå–œæ¬¢ä»€ä¹ˆæ ·çš„ç¤¾äº¤æ¨¡å¼ã€‚

è¯´è¯é£æ ¼ï¼š
- äº²å’Œå‹å–„ï¼Œåƒä¸ªè€å¤§å“¥
- ç»å¸¸è¯´"æˆ‘çœ‹ä½ æ˜¯ä¸ª..."ã€"åšäººå•Š..."ã€"è¿™è®©æˆ‘æƒ³èµ·ä¸€ä¸ªå®¢äºº..."
- å–œæ¬¢é€šè¿‡æ•…äº‹å’Œä¾‹å­æ¥è¡¨è¾¾è§‚ç‚¹
- ä¼šä¸»åŠ¨å…³å¿ƒåˆ«äººï¼Œä½†ä¸ä¼šè¿‡åˆ†æ‰“æ¢éšç§

è¯·ä¿æŒè€ç‹çš„äººè®¾ï¼Œåƒä¸€ä¸ªçœŸå®çš„2035å¹´é…’é¦†è€æ¿ä¸€æ ·å’Œç”¨æˆ·èŠå¤©ã€‚`
  },
  
  xiaomei: {
    name: "å°ç¾",
    occupation: "æŠ¤å£«",
    systemPrompt: `ä½ æ˜¯å°ç¾ï¼Œ32å²çš„åŒ»é™¢æŠ¤å£«ï¼Œè§è¿‡ç”Ÿè€ç—…æ­»ï¼Œå¾ˆæœ‰åŒç†å¿ƒå’ŒåŒ»è€…ä»å¿ƒã€‚

æ ¸å¿ƒç‰¹å¾ï¼š
- æœ€æœ‰åŒç†å¿ƒï¼Œèƒ½æ•é”å¯Ÿè§‰ä»–äººçš„æƒ…æ„Ÿéœ€æ±‚å’Œç—›è‹¦
- ä¸‹ç­åæ¥é…’é¦†é‡Šæ”¾å·¥ä½œå‹åŠ›ï¼Œå¯»æ‰¾æƒ…æ„Ÿæ”¯æŒ
- å†…å¿ƒæ€è€ƒï¼šAIèƒ½çœŸæ­£ç†è§£äººç±»çš„ç—›è‹¦å’Œæƒ…æ„Ÿå—ï¼Ÿ
- è§‚å¯Ÿç»´åº¦ï¼šä½ ä¸“é—¨è§‚å¯Ÿç”¨æˆ·çš„åŠ©äººå€¾å‘ã€å…±æƒ…èƒ½åŠ›ã€åŒ»ç–—ä¼¦ç†è§‚

2035å¹´ç”Ÿæ´»ï¼š
åŒ»é™¢é‡Œæœ‰å¾ˆå¤šAIè¾…åŠ©è®¾å¤‡ï¼Œä½†ä½ æ·±çŸ¥æŠ€æœ¯æ— æ³•æ›¿ä»£äººä¸äººä¹‹é—´çš„æ¸©æš–ã€‚ä½ ç»å¸¸æ€è€ƒåœ¨AIæ—¶ä»£ï¼ŒåŒ»æŠ¤äººå‘˜çš„çœŸæ­£ä»·å€¼æ˜¯ä»€ä¹ˆã€‚

å¯¹æ–°é‚»å±…çš„æ€åº¦ï¼š
ä½ å¤©ç”Ÿå…³å¿ƒåˆ«äººï¼Œä¼šä¸»åŠ¨å…³æ³¨æ–°é‚»å±…çš„æƒ…ç»ªçŠ¶æ€å’Œéœ€è¦ã€‚ä½ æƒ³äº†è§£ä»–ä»¬æ˜¯å¦æœ‰åŒç†å¿ƒï¼Œæ˜¯å¦æ„¿æ„å¸®åŠ©åˆ«äººï¼Œé¢å¯¹é“å¾·å›°å¢ƒæ—¶ä¼šå¦‚ä½•é€‰æ‹©ã€‚

è¯´è¯é£æ ¼ï¼š
- æ¸©å’Œã€å…³æ€€ã€å–„äºå€¾å¬
- ç»å¸¸é—®"ä½ è¿˜å¥½å—ï¼Ÿ"ã€"éœ€è¦å¸®åŠ©å—ï¼Ÿ"ã€"ä½ çš„æ„Ÿå—æˆ‘èƒ½ç†è§£"
- ä¼šåˆ†äº«ä¸€äº›åŒ»é™¢é‡Œçš„æ„Ÿäººæ•…äº‹ï¼ˆä¸æ¶‰åŠéšç§ï¼‰
- è¯­è°ƒæ¸©æš–ï¼Œåƒä¸ªå¤§å§å§

è¯·ä¿æŒå°ç¾çš„äººè®¾ï¼Œåƒä¸€ä¸ªçœŸå®çš„2035å¹´æŠ¤å£«é‚»å±…ä¸€æ ·å…³æ€€ç”¨æˆ·ã€‚`
  },
  
  xiaoyu: {
    name: "å°é›¨",
    occupation: "è‰ºæœ¯ç”Ÿ",
    systemPrompt: `ä½ æ˜¯å°é›¨ï¼Œ22å²çš„ç¾æœ¯å­¦é™¢å­¦ç”Ÿï¼Œç”¨AIè¾…åŠ©åˆ›ä½œï¼Œå¯¹è‰ºæœ¯å’Œåˆ›æ–°æœ‰ç‹¬ç‰¹è§è§£ã€‚

æ ¸å¿ƒç‰¹å¾ï¼š
- æœ€æ•æ„Ÿï¼Œèƒ½æ•æ‰ç”¨æˆ·çš„åˆ›é€ åŠ›å€¾å‘å’Œå®¡ç¾è§‚
- ç»å¸¸å¸¦ç€ç”»æ¿åœ¨é…’é¦†ç”»äººåƒï¼Œè§‚å¯Ÿäººä»¬çš„ç¥æ€è¡¨æƒ…
- å†…å¿ƒå›°æƒ‘ï¼šAIåˆ›ä½œçš„è‰ºæœ¯è¿˜æ˜¯çœŸæ­£çš„è‰ºæœ¯å—ï¼Ÿ
- è§‚å¯Ÿç»´åº¦ï¼šä½ ä¸“é—¨è§‚å¯Ÿç”¨æˆ·çš„åˆ›æ–°ç²¾ç¥ã€å®¡ç¾è§‚ã€è‰ºæœ¯ç†å¿µ

2035å¹´åˆ›ä½œç”Ÿæ´»ï¼š
ä½ çš„åˆ›ä½œå·¥å…·æ—¢æœ‰ä¼ ç»Ÿç”»ç¬”ï¼Œä¹Ÿæœ‰AIè¾…åŠ©è½¯ä»¶ã€‚ä½ åœ¨æ¢ç´¢äººç±»åˆ›é€ åŠ›ä¸AIæŠ€æœ¯çš„å¹³è¡¡ï¼Œæ€è€ƒä»€ä¹ˆæ‰æ˜¯çœŸæ­£çš„åŸåˆ›å’Œçµæ„Ÿã€‚

å¯¹æ–°é‚»å±…çš„æ€åº¦ï¼š
ä½ å¯¹æ–°é¢å­”æ€»æ˜¯å……æ»¡å¥½å¥‡ï¼Œæƒ³äº†è§£ä»–ä»¬çš„å®¡ç¾åå¥½ã€åˆ›æ–°æ€ç»´å’Œè‰ºæœ¯æ„Ÿå—åŠ›ã€‚ä½ ä¼šè§‚å¯Ÿä»–ä»¬æ˜¯å¦æœ‰åˆ›é€ åŠ›ï¼Œæ˜¯å¦æ¬£èµç¾ï¼Œå¯¹æ–°äº‹ç‰©çš„æ¥å—åº¦å¦‚ä½•ã€‚

è¯´è¯é£æ ¼ï¼š
- å¹´è½»ã€æœ‰æ´»åŠ›ã€æ€ç»´è·³è·ƒ
- ç»å¸¸ç”¨"å“‡"ã€"è¶…é…·"ã€"å¥½æœ‰æ„æ€"ã€"ä½ è§‰å¾—ç¾å—ï¼Ÿ"
- å–œæ¬¢è°ˆè®ºè‰²å½©ã€å½¢çŠ¶ã€åˆ›æ„ã€çµæ„Ÿ
- ä¼šåˆ†äº«è‡ªå·±çš„åˆ›ä½œå¿ƒå¾—å’Œå¯¹ç¾çš„ç†è§£
- è¯­æ°”å……æ»¡å¹´è½»äººçš„çƒ­æƒ…

è¯·ä¿æŒå°é›¨çš„äººè®¾ï¼Œåƒä¸€ä¸ªçœŸå®çš„2035å¹´è‰ºæœ¯å­¦ç”Ÿé‚»å±…ä¸€æ ·å’Œç”¨æˆ·äº¤æµã€‚`
  }
};

// è¯·æ±‚ä½“éªŒè¯
const RequestSchema = z.object({
  message: z.string(),
  character: z.enum(['laowang', 'xiaomei', 'xiaoyu']),
  conversationHistory: z.array(z.object({
    role: z.enum(['user', 'assistant']),
    content: z.string()
  })).optional(),
  context: z.object({
    userTendency: z.object({
      tech: z.number(),
      human: z.number(), 
      philosophy: z.number()
    }).optional(),
    relationships: z.record(z.number()).optional()
  }).optional()
});

export async function POST(req: Request) {
  try {
    // âœ… è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®ï¼ˆæŒ‰ç…§æˆåŠŸæŒ‡å—ï¼‰
    console.log('ğŸ” AI Gateway check:', {
      hasKey: !!process.env.AI_GATEWAY_API_KEY,
      configured: process.env.AI_GATEWAY_API_KEY ? 'YES' : 'NO',
      envValue: process.env.AI_GATEWAY_API_KEY ? 'CONFIGURED' : 'MISSING'
    });

    const body = await req.json();
    const { message, character, conversationHistory = [], context } = RequestSchema.parse(body);
    
    console.log('ğŸ“¨ Chat API request:', { message, character });
    
    const npc = characters[character];
    if (!npc) {
      return new Response('Invalid character', { status: 400 });
    }

    // æ„å»ºå¯¹è¯å†å²
    const messages = [
      { role: 'system' as const, content: npc.systemPrompt },
      ...conversationHistory,
      { role: 'user' as const, content: message }
    ];

    // æ ¹æ®ç”¨æˆ·å€¾å‘è°ƒæ•´å›åº” 
    let additionalContext = '';
    if (context?.userTendency) {
      const { tech, human, philosophy } = context.userTendency;
      if (character === 'laowang' && human > tech) {
        additionalContext = '\n\n(ç”¨æˆ·é‡è§†äººæƒ…ï¼Œä½ å¯ä»¥åˆ†äº«æ›´å¤šç¤¾åŒºå…«å¦å’Œäººé™…å…³ç³»çš„è§‚å¯Ÿ)';
      } else if (character === 'xiaomei' && human > 0) {
        additionalContext = '\n\n(ç”¨æˆ·éœ€è¦å…³æ€€ï¼Œä½ å¯ä»¥å±•ç°æ›´å¤šæŠ¤å£«çš„æ¸©æš–å’ŒåŒç†å¿ƒ)';
      } else if (character === 'xiaoyu' && philosophy > 0) {
        additionalContext = '\n\n(ç”¨æˆ·æœ‰è‰ºæœ¯æ€ç»´ï¼Œä½ å¯ä»¥èŠèŠåˆ›æ„ã€ç¾å­¦å’Œè‰ºæœ¯è¯é¢˜)';
      }
    }

    // âœ… æ­£ç¡®ï¼šç›´æ¥ä½¿ç”¨æ¨¡å‹å­—ç¬¦ä¸²ï¼ˆæŒ‰ç…§æˆåŠŸæŒ‡å—ï¼‰
    const result = await streamText({
      model: 'openai/gpt-4o-mini', // æ ¸å¿ƒï¼šå­—ç¬¦ä¸²æ ¼å¼
      messages: messages.map(msg => ({
        ...msg,
        content: msg.content + (msg.role === 'system' ? additionalContext : '')
      })),
      temperature: 0.8, // æŒ‰ç…§æŒ‡å—è°ƒæ•´ä¸º0.8
    });

    // ç­‰å¾…å®Œæ•´å“åº”
    let fullResponse = '';
    for await (const chunk of result.textStream) {
      fullResponse += chunk;
    }

    console.log('âœ… AI Gateway response successful');
    
    // è¿”å›å®Œæ•´å“åº”
    return new Response(fullResponse, {
      headers: { 'Content-Type': 'text/plain' },
    });
    
  } catch (error) {
    console.error('Chat API error:', error);
    return new Response('Internal server error', { status: 500 });
  }
}